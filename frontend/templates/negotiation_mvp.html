<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Negotiation Room - Canada Water</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;800&family=Righteous&family=Rethink+Sans:wght@600&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                        'righteous': ['Righteous', 'cursive'],
                        'rethink': ['Rethink Sans', 'sans-serif'],
                    },
                    colors: {
                        'success': '#16A34A',
                        'warning': '#CA8A04',
                        'destructive': '#DC2626'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #202020;
            font-family: 'Inter', sans-serif;
        }
        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        .chat-bubble {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .avatar-circle {
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .avatar-circle:hover {
            transform: scale(1.1);
        }
        .profile-popup {
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }
        .dimmed-overlay {
            backdrop-filter: blur(4px);
        }
        #three-container {
            touch-action: pan-x pan-y;
        }
    </style>
</head>
<body class="w-screen h-screen overflow-hidden flex items-center justify-center bg-[#202020]">

<!-- Main Container -->
<div id="app" class="relative w-[430px] h-[932px] bg-white shadow-2xl overflow-hidden flex flex-col">
    
    <!-- Background Texture (Subtle) -->
    <div class="absolute inset-0 pointer-events-none z-0">
         <div class="absolute left-1/2 top-1/2 w-[956px] h-[440px] -translate-x-1/2 -translate-y-1/2 rotate-[270deg]">
            <img src="{{ url_for('static', filename='images/home/bg_texture.png') }}" class="w-[191%] max-w-none h-[137%] object-cover opacity-10">
         </div>
    </div>

    <!-- Header Bar -->
    <header class="flex items-center justify-between px-6 h-16 relative z-20">
        <button id="backBtn" class="w-10 h-10 flex items-center justify-center bg-gray-100 rounded-full hover:bg-gray-200 transition-colors shadow-sm">
            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
        </button>
        <h1 class="font-rethink font-bold text-lg text-gray-800 tracking-wide" id="roundTitle">Round 1</h1>
        <button id="stakeholdersBtn" class="w-10 h-10 flex items-center justify-center bg-gray-100 rounded-full hover:bg-gray-200 transition-colors shadow-sm">
            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
            </svg>
        </button>
    </header>

    <!-- 3D Preview Panel -->
    <div id="3dPanel" class="relative mx-4 mt-2 h-[35vh] bg-neutral-100 rounded-[30px] overflow-hidden shadow-inner border border-gray-200 z-10">
        <div class="absolute inset-0" id="three-container">
            <iframe 
                src="/3d/" 
                class="w-full h-full border-0"
                id="threeFrame"
            ></iframe>
        </div>
        
        <button id="expandBtn" class="absolute top-3 right-3 p-2 bg-white/80 backdrop-blur rounded-full hover:bg-white transition-colors shadow-md z-10">
            <svg class="w-4 h-4 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
            </svg>
        </button>

        <div class="absolute bottom-3 left-0 right-0 flex justify-center gap-2 text-[10px]">
            <span class="px-2 py-1 bg-white/90 backdrop-blur rounded-full text-gray-600 border border-gray-100 shadow-sm" id="impact1">Shadow ‚Üë</span>
            <span class="px-2 py-1 bg-white/90 backdrop-blur rounded-full text-gray-600 border border-gray-100 shadow-sm" id="impact2">Density ‚Üì</span>
            <span class="px-2 py-1 bg-white/90 backdrop-blur rounded-full text-success font-medium border border-gray-100 shadow-sm" id="impact3">Green Space +15%</span>
        </div>
    </div>

    <!-- Impact Bar -->
    <div class="px-6 py-3 z-10">
        <div class="flex gap-2 justify-center" id="impactBar">
            <!-- Will be populated dynamically -->
        </div>
    </div>

    <!-- Chat Area -->
    <div id="chatArea" class="flex-1 mx-4 mb-2 overflow-y-auto bg-white/50 backdrop-blur-sm rounded-[30px] border border-gray-100 p-4 shadow-sm z-10">
        <!-- Messages will be added here -->
    </div>

    <!-- Quick Action Buttons -->
    <div class="px-4 py-2 bg-white/80 backdrop-blur border-t border-gray-100 z-20">
        <div class="grid grid-cols-2 gap-2" id="quickActions">
            <button class="action-btn px-3 py-2 bg-gray-50 hover:bg-gray-100 rounded-xl text-xs font-medium text-gray-700 transition-colors border border-gray-200" data-action="gentle">
                Gentle Persuasion
            </button>
            <button class="action-btn px-3 py-2 bg-gray-50 hover:bg-gray-100 rounded-xl text-xs font-medium text-gray-700 transition-colors border border-gray-200" data-action="strong">
                Strong Persuasion
            </button>
            <button class="action-btn px-3 py-2 bg-gray-50 hover:bg-gray-100 rounded-xl text-xs font-medium text-gray-700 transition-colors border border-gray-200" data-action="pressure">
                Pressure Opponent
            </button>
            <button class="action-btn px-3 py-2 bg-gray-50 hover:bg-gray-100 rounded-xl text-xs font-medium text-gray-700 transition-colors border border-gray-200" data-action="alternative">
                Propose Alternative
            </button>
        </div>
    </div>

    <!-- Input Bar -->
    <div class="px-4 py-4 bg-white z-20 safe-area-bottom">
        <div class="flex gap-2">
            <input 
                type="text" 
                id="messageInput" 
                placeholder="Type your message..."
                class="flex-1 px-4 py-3 bg-gray-100 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm font-inter"
            />
            <button id="sendBtn" class="p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-full transition-colors disabled:opacity-50 disabled:cursor-not-allowed shadow-md">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                </svg>
            </button>
        </div>
    </div>
</div>

<!-- Stakeholder Profile Popup -->
<div id="profilePopup" class="hidden fixed inset-0 z-50">
    <div class="dimmed-overlay absolute inset-0 bg-black/40" id="popupOverlay"></div>
    <div class="profile-popup absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl max-h-[85vh] overflow-y-auto shadow-2xl">
        <div class="sticky top-0 bg-white border-b px-4 py-4 flex justify-between items-center z-10">
            <h2 class="text-lg font-bold">Stakeholder Profile</h2>
            <button id="closePopup" class="p-2 hover:bg-gray-100 rounded-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <div class="p-6" id="profileContent">
            <!-- Profile content will be populated here -->
        </div>

        <div class="sticky bottom-0 bg-gradient-to-t from-white via-white to-transparent px-6 py-4 border-t">
            <div class="flex items-center gap-3">
                <div id="profileAvatar" class="w-12 h-12 rounded-full flex items-center justify-center text-2xl"></div>
                <div>
                    <div class="font-semibold" id="profileName"></div>
                    <div class="text-sm text-gray-600" id="profileRole"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Fullscreen 3D Overlay -->
<div id="fullscreen3D" class="hidden fixed inset-0 z-40 bg-black">
    <button id="close3D" class="absolute top-4 right-4 p-3 bg-white/10 hover:bg-white/20 backdrop-blur rounded-lg text-white z-10">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
    </button>
    <iframe id="fullscreenFrame" src="/3d/" class="w-full h-full border-0"></iframe>
</div>

<script>
// Application State
let state = {
    currentRound: 1,
    messages: [],
    stakeholders: [],
    playerProfile: null,
    climateScore: 50,
    selectedStakeholder: null,
    is3DExpanded: false
};

// Fetch initial data from Flask backend
async function initializeNegotiation() {
    try {
        // In a real implementation, this would fetch from your Flask endpoints
        // For now, we'll use the session data that's already available
        const response = await fetch('/api/negotiation/state');
        if (response.ok) {
            const data = await response.json();
            state = { ...state, ...data };
            renderUI();
        }
    } catch (error) {
        console.error('Failed to initialize:', error);
        // Fallback to mock data for demonstration
        initializeMockData();
    }
}

function initializeMockData() {
    // Mock stakeholders matching your Flask backend structure
    try {
        state.stakeholders = {{ characters | tojson | safe }};
        state.playerProfile = {{ player_profile | tojson | safe }};
        state.currentRound = {{ state.round | default(1) }};
        state.climateScore = {{ climate_score | default(50) }};
        
        console.log('Initialized with data:', {
            stakeholders: state.stakeholders.length,
            round: state.currentRound,
            climate: state.climateScore
        });
        
        renderUI();
    } catch (error) {
        console.error('Failed to initialize:', error);
        document.getElementById('chatArea').innerHTML = `
            <div class="text-center py-8">
                <p class="text-red-600 font-semibold mb-2">‚ö†Ô∏è Session Error</p>
                <p class="text-gray-600 text-sm">Please start a new game from the beginning.</p>
                <a href="/" class="inline-block mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Go to Role Selection
                </a>
            </div>
        `;
    }
}

function renderUI() {
    renderImpactBar();
    renderMessages();
    document.getElementById('roundTitle').textContent = `Negotiation Round ${state.currentRound}`;
}

function renderImpactBar() {
    const topStakeholders = state.stakeholders
        .filter(s => !s.is_player)
        .sort((a, b) => Math.abs(b.stance_score - 50) - Math.abs(a.stance_score - 50))
        .slice(0, 3);
    
    const impactBar = document.getElementById('impactBar');
    impactBar.innerHTML = topStakeholders.map(stakeholder => {
        const impact = stakeholder.stance_score > 60 ? 
            Math.floor((stakeholder.stance_score - 60) / 10) : 
            stakeholder.stance_score < 40 ? -Math.floor((40 - stakeholder.stance_score) / 10) : 0;
        
        const emoji = getStanceEmoji(stakeholder.stance_score);
        const color = impact > 0 ? 'text-success' : impact < 0 ? 'text-destructive' : 'text-gray-500';
        
        return `
            <div class="flex items-center gap-2 px-3 py-2 bg-white rounded-lg shadow-sm border">
                <span class="text-lg">${emoji}</span>
                <span class="text-xs font-medium text-gray-700">${stakeholder.role_name}</span>
                <span class="text-sm font-bold ${color}">${impact > 0 ? '+' : ''}${impact}</span>
            </div>
        `;
    }).join('');
}

function getStanceEmoji(score) {
    if (score >= 70) return 'üòä';
    if (score >= 55) return 'üôÇ';
    if (score >= 45) return 'üòê';
    if (score >= 30) return 'üòü';
    return 'üò†';
}

function renderMessages() {
    const chatArea = document.getElementById('chatArea');
    const messagesHTML = state.messages.map(msg => createMessageBubble(msg)).join('');
    chatArea.innerHTML = messagesHTML;
    chatArea.scrollTop = chatArea.scrollHeight;
}

function createMessageBubble(message) {
    const isPlayer = message.sender === 'player';
    const stakeholder = isPlayer ? null : state.stakeholders.find(s => s.id === message.stakeholderId);
    
    if (isPlayer) {
        return `
            <div class="chat-bubble flex justify-end mb-4">
                <div class="max-w-[70%] px-4 py-3 bg-blue-600 text-white rounded-2xl rounded-tr-sm">
                    <p class="text-sm leading-relaxed">${message.content}</p>
                </div>
            </div>
        `;
    } else if (stakeholder) {
        const avatarColor = getAvatarColor(stakeholder.role_id);
        return `
            <div class="chat-bubble flex gap-3 mb-4">
                <div class="avatar-circle flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center text-lg" 
                     style="background-color: ${avatarColor};"
                     onclick="showStakeholderProfile('${stakeholder.id}')">
                    ${getStakeholderEmoji(stakeholder.role_id)}
                </div>
                <div class="max-w-[70%]">
                    <div class="text-xs text-gray-600 mb-1 font-medium">${stakeholder.name}</div>
                    <div class="px-4 py-3 bg-white rounded-2xl rounded-tl-sm shadow-sm border">
                        <p class="text-sm text-gray-800 leading-relaxed">${message.content}</p>
                    </div>
                </div>
            </div>
        `;
    }
    return '';
}

function getAvatarColor(roleId) {
    const colors = {
        'developer': '#4F46E5',
        'resident_homeowner': '#DC2626',
        'resident_social': '#16A34A',
        'council_planner': '#CA8A04',
        'community_activist': '#EA580C',
        'potential_buyer': '#0891B2',
        'urban_designer': '#7C3AED'
    };
    return colors[roleId] || '#6B7280';
}

function getStakeholderEmoji(roleId) {
    const emojis = {
        'developer': 'üë©‚Äçüíº',
        'resident_homeowner': 'üë®',
        'resident_social': 'üë©',
        'council_planner': 'üë®‚Äç‚öñÔ∏è',
        'community_activist': 'üë©‚Äçü¶±',
        'potential_buyer': 'üë®‚Äçüíª',
        'urban_designer': 'üë©‚Äçüé®'
    };
    return emojis[roleId] || 'üë§';
}

function showStakeholderProfile(stakeholderId) {
    const stakeholder = state.stakeholders.find(s => s.id === stakeholderId);
    if (!stakeholder) return;
    
    state.selectedStakeholder = stakeholder;
    
    const profileContent = document.getElementById('profileContent');
    profileContent.innerHTML = `
        <div class="bg-gray-50 rounded-xl p-4 mb-6">
            <h3 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
                <span>üìã</span> Attributes
            </h3>
            <div class="space-y-3 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-600">Role:</span>
                    <span class="font-medium text-gray-900">${stakeholder.role_name}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Objectives:</span>
                    <span class="font-medium text-gray-900 text-right max-w-[200px]">${stakeholder.backstory || 'No description'}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Initial Stance:</span>
                    <span class="font-medium text-gray-900">${stakeholder.initial_stance}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Influence Score:</span>
                    <span class="font-medium text-gray-900">${stakeholder.influence}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Gender:</span>
                    <span class="font-medium text-gray-900">${stakeholder.gender}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Age:</span>
                    <span class="font-medium text-gray-900">${stakeholder.age}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Local Born:</span>
                    <span class="font-medium text-gray-900">${stakeholder.local_born}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Stance Score:</span>
                    <span class="font-medium text-gray-900">${stakeholder.stance_score}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Influence Tokens:</span>
                    <span class="font-medium text-gray-900">${stakeholder.influence_tokens}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Max Tokens:</span>
                    <span class="font-medium text-gray-900">${stakeholder.max_tokens}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Trust Value:</span>
                    <span class="font-medium text-gray-900">${stakeholder.trust_value}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Has Children:</span>
                    <span class="font-medium text-gray-900">${stakeholder.has_children}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Number of Children:</span>
                    <span class="font-medium text-gray-900">${stakeholder.num_children || 0}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Marital Status:</span>
                    <span class="font-medium text-gray-900">${stakeholder.marital_status}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Previous Stance Category:</span>
                    <span class="font-medium text-gray-900">${stakeholder.previous_stance_category || stakeholder.stance}</span>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('profileName').textContent = stakeholder.name;
    document.getElementById('profileRole').textContent = stakeholder.role_name;
    const profileAvatar = document.getElementById('profileAvatar');
    profileAvatar.style.backgroundColor = getAvatarColor(stakeholder.role_id);
    profileAvatar.textContent = getStakeholderEmoji(stakeholder.role_id);
    
    document.getElementById('profilePopup').classList.remove('hidden');
}

// Event Listeners
document.getElementById('closePopup').addEventListener('click', () => {
    document.getElementById('profilePopup').classList.add('hidden');
});

document.getElementById('popupOverlay').addEventListener('click', () => {
    document.getElementById('profilePopup').classList.add('hidden');
});

document.getElementById('expandBtn').addEventListener('click', () => {
    state.is3DExpanded = true;
    document.getElementById('fullscreen3D').classList.remove('hidden');
});

document.getElementById('close3D').addEventListener('click', () => {
    state.is3DExpanded = false;
    document.getElementById('fullscreen3D').classList.add('hidden');
});

document.getElementById('backBtn').addEventListener('click', () => {
    if (confirm('Are you sure you want to leave the negotiation?')) {
        window.location.href = '/home';
    }
});

// Quick action buttons
document.querySelectorAll('.action-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
        const action = btn.dataset.action;
        const actionTexts = {
            'gentle': 'I understand your concerns. Perhaps we could find a middle ground that benefits everyone?',
            'strong': 'This proposal is crucial for the community\'s future. We need your full support to make it work.',
            'pressure': 'If we don\'t move forward now, we risk losing this opportunity entirely. The community is counting on us.',
            'alternative': 'What if we considered a phased approach? This could address your concerns while maintaining momentum.'
        };
        
        document.getElementById('messageInput').value = actionTexts[action];
        btn.disabled = true;
        setTimeout(() => btn.disabled = false, 500);
    });
});

// Send message
async function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add player message immediately
    state.messages.push({
        id: Date.now().toString(),
        sender: 'player',
        content: message,
        timestamp: new Date()
    });
    
    input.value = '';
    renderMessages();
    
    // Show thinking indicator
    const chatArea = document.getElementById('chatArea');
    const thinkingId = 'thinking-' + Date.now();
    chatArea.insertAdjacentHTML('beforeend', `
        <div id="${thinkingId}" class="chat-bubble flex gap-3 mb-4 opacity-50">
            <div class="avatar-circle flex-shrink-0 w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-lg">
                ü§ñ
            </div>
            <div class="max-w-[70%]">
                <div class="text-xs text-gray-500 mb-1 font-medium">AI Agents</div>
                <div class="px-4 py-3 bg-white rounded-2xl rounded-tl-sm shadow-sm border">
                    <p class="text-sm text-gray-500 italic">Thinking...</p>
                </div>
            </div>
        </div>
    `);
    chatArea.scrollTop = chatArea.scrollHeight;
    
    // Send to Flask backend
    try {
        const response = await fetch('/negotiation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest' // Signal AJAX request
            },
            body: `action=submit_statement&player_statement=${encodeURIComponent(message)}`
        });
        
        // Remove thinking indicator
        const thinkingEl = document.getElementById(thinkingId);
        if (thinkingEl) thinkingEl.remove();
        
        if (response.ok) {
            const data = await response.json();
            
            if (data.status === 'success') {
                // Update state with new data
                state.currentRound = data.new_round;
                state.climateScore = data.climate_score;
                state.messages = data.history; // Replace history with full synced history
                
                // Update UI
                renderUI();
                
                if (data.event_text) {
                    // Show event toast/notification if needed
                    alert("Event: " + data.event_text); // Simple fallback, can be improved
                }
            } else {
                console.error('Server returned error:', data);
            }
        } else {
            console.error('Network response was not ok');
        }
    } catch (error) {
        console.error('Failed to send message:', error);
        // Remove thinking indicator on error
        const thinkingEl = document.getElementById(thinkingId);
        if (thinkingEl) thinkingEl.remove();
    }
}

document.getElementById('backBtn').addEventListener('click', () => {
    if (confirm('Are you sure you want to leave the negotiation? Progress will be lost.')) {
        window.location.href = '/role_selection';
    }
});

document.getElementById('sendBtn').addEventListener('click', sendMessage);
document.getElementById('messageInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
});

// Initialize on load
window.addEventListener('load', () => {
    // Use the data injected by Jinja2 directly
    try {
        state.stakeholders = {{ characters | tojson | safe }};
        state.playerProfile = {{ player_profile | tojson | safe }};
        state.currentRound = {{ state.round | default(1) }};
        state.climateScore = {{ climate_score | default(50) }};
        
        // Load existing history if any
        const rawHistory = {{ state.history | tojson | safe }} || [];
        // Convert history format to messages format if needed, or rely on backend to provide consistent format on load
        // For MVP, let's just render UI. Messages might be empty initially.
        
        renderUI();
    } catch (e) {
        console.error("Error initializing from template data", e);
    }
});
</script>

</body>
</html>
